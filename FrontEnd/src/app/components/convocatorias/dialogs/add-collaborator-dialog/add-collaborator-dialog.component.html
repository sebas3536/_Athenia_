<div *ngIf="open" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"
    (click)="onBackdropClick()" (keydown)="onKeydown($event)" tabindex="-1" role="dialog" aria-modal="true"
    aria-labelledby="dialog-title">

    <button class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl animate-scale-in max-h-[90vh] overflow-y-auto"
        (click)="onDialogClick($event)" role="document">

        <!-- Header -->
        <div class="flex items-center justify-between mb-4 sticky top-0 bg-white">
            <h2 id="dialog-title" class="text-xl font-semibold text-[#070025]">
                Agregar Colaboradores
            </h2>
            <button (click)="close()" [disabled]="isLoading"
                class="p-1 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors disabled:opacity-50"
                aria-label="Cerrar">
                <lucide-angular name="X" class="w-5 h-5"></lucide-angular>
            </button>
        </div>

        <!-- Form -->
        <form (ngSubmit)="onSubmit()" class="space-y-6">

            <!-- Subtitle -->
            <p class="text-sm text-gray-600">
                Selecciona usuarios y asigna un rol para darles acceso a esta convocatoria.
            </p>

            <!-- Users Selection Section -->
            <fieldset class="space-y-3">
                <legend class="block text-sm font-medium text-gray-700 mb-3">
                    Seleccionar Usuarios
                    <span class="text-red-500">*</span>
                </legend>

                <!-- Available Users List -->
                <div class="border rounded-lg p-3 max-h-60 overflow-y-auto space-y-2">
                    <div *ngIf="availableUsers.length === 0" class="text-center py-8 text-gray-500">
                        <lucide-angular name="Users" class="w-8 h-8 mx-auto mb-2 opacity-50"></lucide-angular>
                        <p class="text-sm">No hay usuarios disponibles</p>
                    </div>

                    <label *ngFor="let user of availableUsers" [for]="'user-' + user.id"
                        class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                        <input type="checkbox" [id]="'user-' + user.id" [checked]="isUserSelected(user.id)"
                            (change)="toggleUser(user.id)" [disabled]="isLoading"
                            class="w-4 h-4 text-[#02ab74] border-gray-300 rounded focus:ring-[#02ab74] disabled:cursor-not-allowed" />

                        <app-profile-avatar [size]="2" [showEditControls]="false"
                            [userPhotoUrl]="user.profile_photo_url" [userData]="user"
                            class="flex-shrink-0"></app-profile-avatar>


                        <div class="flex items-center gap-2 min-w-0">
                            <p class="font-medium text-sm text-[#070025]">{{ user.name }}</p>
                            <p class="text-sm text-gray-500">â€¢ {{ user.role }}</p>
                        </div>

                    </label>
                </div>

                <!-- Error Message -->
                <p *ngIf="showErrors && selectedUserIds.size === 0"
                    class="text-sm text-red-600 flex items-center gap-1">
                    <lucide-angular name="AlertCircle" class="w-3 h-3"></lucide-angular>
                    Selecciona al menos un usuario
                </p>
            </fieldset>

            <div class="border-t pt-4"></div>

            <!-- Role Selection Section -->
            <fieldset class="space-y-3">
                <legend class="block text-sm font-medium text-gray-700 mb-3">
                    Rol
                    <span class="text-red-500">*</span>
                </legend>

                <div class="grid grid-cols-2 gap-2" role="radiogroup">
                    <!-- Editor Role -->
                    <button type="button" (click)="selectedRole = 'editor'" role="radio"
                        [attr.aria-checked]="selectedRole === 'editor'"
                        class="p-3 border-2 rounded-lg text-center transition-all" [ngClass]="
                            selectedRole === 'editor'
                                ? 'border-[#02ab74] bg-[#02ab74]/5'
                                : 'border-gray-200 hover:border-gray-300'
                        ">
                        <lucide-angular name="Edit" class="w-5 h-5 mx-auto mb-1"
                            [ngClass]="selectedRole === 'editor' ? 'text-[#02ab74]' : 'text-gray-400'">
                        </lucide-angular>
                        <p class="text-xs font-medium"
                            [ngClass]="selectedRole === 'editor' ? 'text-[#02ab74]' : 'text-gray-600'">
                            Editor
                        </p>
                    </button>

                    <!-- Admin Role -->
                    <button type="button" (click)="selectedRole = 'admin'" role="radio"
                        [attr.aria-checked]="selectedRole === 'admin'"
                        class="p-3 border-2 rounded-lg text-center transition-all" [ngClass]="
                            selectedRole === 'admin'
                                ? 'border-[#02ab74] bg-[#02ab74]/5'
                                : 'border-gray-200 hover:border-gray-300'
                        ">
                        <lucide-angular name="Shield" class="w-5 h-5 mx-auto mb-1"
                            [ngClass]="selectedRole === 'admin' ? 'text-[#02ab74]' : 'text-gray-400'">
                        </lucide-angular>
                        <p class="text-xs font-medium"
                            [ngClass]="selectedRole === 'admin' ? 'text-[#02ab74]' : 'text-gray-600'">
                            Admin
                        </p>
                    </button>
                </div>

                <!-- Role Description -->
                <p class="text-xs text-gray-600 p-2 bg-gray-50 rounded">
                    {{ getRoleDescription(selectedRole) }}
                </p>
            </fieldset>

            <div class="border-t pt-4"></div>

            <!-- Selected Users Summary -->
            <div *ngIf="selectedUserIds.size > 0" class="p-3 bg-[#02ab74]/5 rounded-lg border border-[#02ab74]/20">
                <p class="text-xs font-medium text-gray-700 mb-2">
                    <lucide-angular name="Check" class="w-3 h-3 inline mr-1"></lucide-angular>
                    {{ selectedUserIds.size }} usuario(s) seleccionado(s)
                </p>
                <div class="flex flex-wrap gap-2">
                    <span *ngFor="let user of selectedUsersArray"
                        class="inline-flex items-center gap-1 px-2 py-1 bg-white rounded text-xs font-medium text-[#070025] border border-[#02ab74]/30">
                        {{ user.name }}
                        <button type="button" (click)="toggleUser(user.id)"
                            class="ml-1 text-[#02ab74] hover:text-red-600">
                            <lucide-angular name="X" class="w-3 h-3"></lucide-angular>
                        </button>
                    </span>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" (click)="close()" [disabled]="isLoading"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Cancelar
                </button>
                <button type="submit" [disabled]="isLoading || selectedUserIds.size === 0"
                    class="px-4 py-2 bg-[#02ab74] hover:bg-[#02ab74]/90 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 min-w-[140px] justify-center">
                    <span *ngIf="isLoading"
                        class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
                    <lucide-angular *ngIf="!isLoading" name="Plus" class="w-4 h-4"></lucide-angular>
                    {{ isLoading ? 'Agregando...' : 'Agregar (' + selectedUserIds.size + ')' }}
                </button>
            </div>
        </form>
    </button>
</div>