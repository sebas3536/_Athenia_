<!-- eslint-disable @angular-eslint/template/no-autofocus -->
<div *ngIf="open" class="fixed inset-0 bg-black/50 z-40 animate-fade-in" (click)="onBackdropClick()"
    role="presentation">
</div>
<!-- Dialog -->
<div *ngIf="open" class="fixed inset-0 flex items-center justify-center z-50" (keydown)="onKeydown($event)"
    role="dialog" aria-modal="true" aria-labelledby="dialog-title">

    <button class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl animate-scale-in"
        (click)="onDialogClick($event)">

        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <h2 id="dialog-title" class="text-xl font-semibold text-gray-900">
                Agregar Documento al Checklist
            </h2>
            <button type="button" (click)="close()" [disabled]="isLoading"
                class="p-1 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors disabled:opacity-50"
                aria-label="Cerrar">
                <lucide-angular name="X" class="w-5 h-5"></lucide-angular>
            </button>
        </div>

        <!-- Form -->
        <form (ngSubmit)="onSubmit()" class="space-y-4">

            <!-- Name Field -->
            <div>
                <label for="doc-name" class="block text-sm font-medium text-gray-700 mb-1">
                    Nombre del Documento
                    <span class="text-red-500">*</span>
                </label>
                <input id="doc-name" type="text" [(ngModel)]="documentName" name="documentName"
                    placeholder="Ej: Propuesta Técnica" [disabled]="isLoading" [class.border-red-500]="isNameInvalid"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-100 disabled:cursor-not-allowed transition-colors"
                    autofocus />

                <!-- Error Message -->
                <p *ngIf="isNameInvalid" class="mt-1 text-sm text-red-600 flex items-center gap-1">
                    <lucide-angular name="AlertCircle" class="w-3 h-3"></lucide-angular>
                    El nombre es obligatorio
                </p>
            </div>

            <!-- Divider -->
            <div class="border-t pt-4">

                <!-- Has Document Checkbox -->
                <div class="mb-3">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input id="has-doc-checkbox" type="checkbox" [(ngModel)]="hasDocument" name="hasDocument"
                            (change)="onHasDocumentChange()" [disabled]="isLoading"
                            class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500 disabled:cursor-not-allowed" />
                        <span class="text-sm text-gray-700 group-hover:text-gray-900 transition-colors">
                            Ya tengo este documento para subir
                        </span>
                    </label>
                </div>

                <!-- File Upload Section -->
                <div *ngIf="hasDocument" class="pl-6 space-y-3 animate-slide-down">
                    <label for="file-input" class="block text-sm font-medium text-gray-700">
                        Seleccionar archivo
                    </label>

                    <div class="relative">
                        <input id="file-input" type="file" (change)="onFileSelected($event)" [disabled]="isLoading"
                            class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100 file:cursor-pointer cursor-pointer disabled:cursor-not-allowed disabled:opacity-50" />
                    </div>

                    <!-- File Info -->
                    <div *ngIf="selectedFile" class="p-3 bg-green-50 rounded-md border border-green-200">
                        <div class="flex items-start gap-2">
                            <lucide-angular name="FileCheck"
                                class="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"></lucide-angular>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-green-800 font-medium truncate">
                                    {{ selectedFile.name }}
                                </p>
                                <p class="text-xs text-green-600">
                                    {{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending State Info -->
                <div *ngIf="!hasDocument"
                    class="pl-6 p-3 bg-orange-50 rounded-md border border-orange-200 animate-slide-down">
                    <p class="text-sm text-orange-800 flex items-start gap-2">
                        <lucide-angular name="AlertCircle" class="w-4 h-4 mt-0.5 flex-shrink-0"></lucide-angular>
                        <span>Este documento se agregará como <strong>pendiente</strong> y podrás subirlo más tarde
                            desde el checklist.</span>
                    </p>
                </div>
            </div>

            <!-- Helper Text -->
            <div class="p-3 bg-blue-50 rounded-md border border-blue-200">
                <p class="text-sm text-blue-800 flex items-start gap-2">
                    <lucide-angular name="Info" class="w-4 h-4 mt-0.5 flex-shrink-0"></lucide-angular>
                    <span>Los documentos pendientes aparecerán en el checklist y podrás gestionarlos
                        individualmente.</span>
                </p>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" (click)="close()" [disabled]="isLoading"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Cancelar
                </button>
                <!-- ✅ CORREGIDO: Usar [disabled]="!canSubmit" en lugar de múltiples condiciones -->
                <button type="submit" [disabled]="!canSubmit"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 min-w-[140px] justify-center">
                    <span *ngIf="isLoading"
                        class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
                    <lucide-angular *ngIf="!isLoading" name="Plus" class="w-4 h-4"></lucide-angular>
                    {{ isLoading ? 'Agregando...' : 'Agregar Documento' }}
                </button>
            </div>
        </form>
    </button>
</div>