<!-- Modal de Chat -->
<div *ngIf="isVisible" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">

        <!-- Header -->
        <div class="text-white p-4 rounded-t-lg flex items-center justify-between"
            style="background: linear-gradient(to bottom right, #028a5e, #5a058f);">
            <div class="flex items-center gap-3">
                <lucide-angular name="bot" class="w-8 h-8"></lucide-angular>
                <div>
                    <h3 class="text-xl font-bold">ATHENIA</h3>
                    <p class="text-sm opacity-90" *ngIf="atheniaStatus">
                        {{ atheniaStatus.documents_indexed }} documentos indexados
                    </p>
                </div>
            </div>

            <button (click)="toggle()"
                class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                <lucide-angular name="x" class="w-6 h-6"></lucide-angular>
            </button>
        </div>

        <!-- Messages Area -->
        <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">

            <!-- Empty State -->
            <div *ngIf="messages.length === 0" class="text-center py-12">
                <lucide-angular name="message-circle" class="w-16 h-16 mx-auto text-gray-300 mb-4"></lucide-angular>
                <h4 class="text-lg font-semibold text-gray-600 mb-2">¡Hola! Soy ATHENIA</h4>
                <p class="text-gray-500">Pregúntame sobre tus documentos</p>
            </div>

            <!-- Messages -->
            <div *ngFor="let message of messages"
                [ngClass]="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">

                <div [ngClass]="message.role === 'user' 
                         ? 'bg-blue-500 text-white' 
                         : 'bg-white border border-gray-200'" class="max-w-[75%] rounded-lg p-3 shadow-sm">

                    <!-- User Message -->
                    <div *ngIf="message.role === 'user'">
                        <p class="text-sm">{{ message.content }}</p>
                    </div>

                    <!-- Assistant Message -->
                    <div *ngIf="message.role === 'assistant'">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">{{ message.content }}</p>

                        <!-- Metadata -->
                        <div
                            class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between text-xs text-gray-500">
                            <span *ngIf="message.from_cache" class="flex items-center gap-1">
                                <lucide-angular name="zap" class="w-3 h-3 text-yellow-500"></lucide-angular>
                                Caché
                            </span>
                            <span *ngIf="message.confidence" class="flex items-center gap-1">
                                <lucide-angular name="check-circle" class="w-3 h-3 text-green-500"></lucide-angular>
                                {{ (message.confidence * 100).toFixed(0) }}% confianza
                            </span>
                            <span *ngIf="message.sources && message.sources.length > 0">
                                {{ message.sources.length }} fuentes
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div *ngIf="isLoading" class="flex justify-start">
                <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                    <div class="flex items-center gap-2 text-gray-500">
                        <lucide-angular name="loader-2" class="w-4 h-4 animate-spin"></lucide-angular>
                        <span class="text-sm">ATHENIA está pensando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-white rounded-b-lg">
            <div class="flex gap-2">
                <input #questionInput type="text" [(ngModel)]="question" (keypress)="onKeyPress($event)"
                    placeholder="Escribe tu pregunta..." [disabled]="isLoading"
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />

                <button (click)="sendQuestion()" [disabled]="isLoading || !question.trim()"
                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <lucide-angular name="send" class="w-4 h-4"></lucide-angular>
                    Enviar
                </button>
            </div>

            <p class="text-xs text-gray-500 mt-2">
                Presiona Enter para enviar
                <span *ngIf="atheniaStatus?.documents_indexed > 0">
                    • {{ atheniaStatus.documents_indexed }} documentos disponibles
                </span>
            </p>
        </div>

    </div>
</div>