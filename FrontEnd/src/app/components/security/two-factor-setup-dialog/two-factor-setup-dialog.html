<!-- Overlay -->
<div *ngIf="open" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" (click)="closeDialog()"
    (keydown.enter)="closeDialog()" (keydown.space)="closeDialog()" tabindex="0" role="button"
    aria-label="Cerrar diálogo">
    <!-- Dialog Content -->
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()" (keydown.enter)="$event.stopPropagation()"
        (keydown.space)="$event.stopPropagation()" tabindex="-1" role="dialog" aria-modal="true"
        aria-labelledby="dialog-title" aria-describedby="dialog-description">

        <!-- Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 rounded-lg" style="background: linear-gradient(to bottom right, #02ab74, #7209b7);">
                    <lucide-angular name="shield" class="w-6 h-6 text-white"></lucide-angular>
                </div>
                <h2 id="dialog-title" class="text-[#070025] text-xl font-semibold">
                    Configurar Autenticación de Dos Factores
                </h2>
            </div>
            <p id="dialog-description" class="text-gray-600 text-sm">
                <span *ngIf="step === 'qr'">Escanea el código QR con tu aplicación de autenticación</span>
                <span *ngIf="step === 'verify'">Verifica tu configuración ingresando el código</span>
                <span *ngIf="step === 'backup'">Guarda estos códigos de respaldo en un lugar seguro</span>
            </p>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-6">
            <!-- Progress -->
            <div class="flex items-center gap-2">
                <!-- Step 1 -->
                <div class="flex items-center gap-2">
                    <div
                        [class]="step === 'qr' ? 'w-8 h-8 rounded-full bg-[#02ab74] text-white flex items-center justify-center' : 'w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center'">
                        <!-- Verify Step -->
                        <svg *ngIf="step !== 'qr'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>

                        <span *ngIf="step === 'qr'">1</span>
                    </div>
                    <span [class]="step === 'qr' ? 'text-sm text-[#02ab74]' : 'text-sm text-green-600'">Escanear</span>
                </div>

                <!-- Line 1 -->
                <div class="flex-1 h-1 rounded"
                    [class]="step === 'verify' || step === 'backup' ? 'bg-[#02ab74]' : 'bg-gray-200'"></div>

                <!-- Step 2 -->
                <div class="flex items-center gap-2">
                    <div
                        [class]="step === 'verify' ? 'w-8 h-8 rounded-full bg-[#02ab74] text-white flex items-center justify-center' : step === 'backup' ? 'w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center' : 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center'">
                        <!-- Verify Step -->
                        <svg *ngIf="step === 'backup'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" class="w-5 h-5">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span *ngIf="step !== 'backup'">2</span>
                    </div>
                    <span
                        [class]="step === 'verify' ? 'text-sm text-[#02ab74]' : step === 'backup' ? 'text-sm text-green-600' : 'text-sm text-gray-500'">Verificar</span>
                </div>

                <!-- Line 2 -->
                <div class="flex-1 h-1 rounded" [class]="step === 'backup' ? 'bg-[#02ab74]' : 'bg-gray-200'"></div>

                <!-- Step 3 -->
                <div class="flex items-center gap-2">
                    <div
                        [class]="step === 'backup' ? 'w-8 h-8 rounded-full bg-[#02ab74] text-white flex items-center justify-center' : 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center'">
                        3
                    </div>
                    <span
                        [class]="step === 'backup' ? 'text-sm text-[#02ab74]' : 'text-sm text-gray-500'">Respaldo</span>
                </div>
            </div>

            <!-- QR Code Step -->
            <div *ngIf="step === 'qr'" class="space-y-4">
                <!-- App Instructions -->
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-start gap-3">
                        <!-- Verify Step -->
                        <svg xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0">
                            <rect width="14" height="20" x="5" y="2" rx="2" ry="2"></rect>
                            <path d="M12 18h.01"></path>
                        </svg>
                        <div>
                            <h4 class="text-blue-900 mb-2 font-medium">Aplicaciones recomendadas:</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• Google Authenticator</li>
                                <li>• Microsoft Authenticator</li>
                                <li>• Authy</li>
                                <li>• 1Password</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="flex flex-col items-center space-y-4">
                    <div class="p-4 bg-white border-2 border-gray-200 rounded-2xl">
                        <img [src]="qrCodeUrl" alt="QR Code" class="w-48 h-48" />
                    </div>

                    <!-- Manual Setup -->
                    <div class="w-full bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">O ingresa este código manualmente:</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <code
                                class="flex-1 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-mono text-[#070025] break-all">
                {{ secretKey }}
              </code>
                            <button (click)="handleCopySecret()"
                                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex-shrink-0">
                                <!-- Actions -->
                                <svg *ngIf="!copiedSecret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="w-4 h-4">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                                </svg>

                                <svg *ngIf="copiedSecret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="w-4 h-4 text-green-600">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>

                            </button>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-2">
                    <button (click)="continueToVerify()"
                        class="w-full px-4 py-2.5 bg-[#02ab74] hover:bg-[#028a5f] text-white rounded-lg font-medium transition-colors">
                        Continuar
                    </button>
                    <button (click)="handleCancel()"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>

            <!-- Verify Step -->
            <div *ngIf="step === 'verify'" class="space-y-6">
                <div class="text-center space-y-6">
                    <div class="flex justify-center">
                        <div class="p-3 bg-gradient-to-br from-[#02ab74]/10 to-[#7209b7]/10 rounded-full">
                            <!-- Verify Step -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-[#02ab74]">
                                <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"></path>
                                <path d="m21 2-9.6 9.6"></path>
                                <circle cx="7.5" cy="15.5" r="5.5"></circle>
                            </svg>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[#070025] mb-2 font-semibold">Ingresa el código de verificación</h3>
                        <p class="text-gray-600 text-sm">
                            Abre tu aplicación de autenticación y escribe el código de 6 dígitos
                        </p>
                    </div>

                    <!-- OTP Input -->

                    <div class="flex justify-center gap-2">
                        <ng-otp-input (onInputChange)="handleOtpInput( $event)"
                            [config]="{ length: 6, inputStyles: { 'width': '40px', 'height': '56px', 'fontSize': '1.25rem', 'borderColor': '#ccc' } }"></ng-otp-input>
                    </div>
                </div>
                <!-- Actions -->
                <div class="flex gap-3">
                    <button (click)="goBack()"
                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Atrás
                    </button>
                    <button (click)="handleVerify()" [disabled]="!isCodeComplete" [class.opacity-50]="!isCodeComplete"
                        [class.cursor-not-allowed]="!isCodeComplete"
                        class="flex-1 px-4 py-2.5 bg-[#02ab74] hover:bg-[#028a5f] text-white rounded-lg font-medium transition-colors">
                        Verificar
                    </button>
                </div>
            </div>

            <!-- Backup Codes Step -->
            <div *ngIf="step === 'backup'" class="space-y-4">
                <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                    <div class="flex items-start gap-3">
                        <!-- Verify Step-->
                        <svg xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0">
                            <path
                                d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z">
                            </path>
                        </svg>

                        <div>
                            <h4 class="text-orange-900 mb-1 font-medium">¡Importante!</h4>
                            <p class="text-sm text-orange-800">
                                Guarda estos códigos en un lugar seguro. Podrás usarlos si pierdes acceso a tu
                                aplicación de autenticación. Cada código solo puede usarse una vez.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Backup Codes -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div *ngFor="let code of backupCodes"
                            class="px-3 py-2 bg-white border border-gray-200 rounded-lg font-mono text-sm text-[#070025] text-center">
                            {{ code }}
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button (click)="handleCopyBackupCodes()"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <!-- Verify Step -->
                            <svg *ngIf="!copiedBackup" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="w-4 h-4">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                            </svg>
                            <svg *ngIf="copiedBackup" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="w-4 h-4 text-green-600">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>

                            {{ copiedBackup ? 'Copiado' : 'Copiar' }}
                        </button>
                        <button (click)="handleDownloadBackupCodes()"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <!-- Verify Step -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" x2="12" y1="15" y2="3"></line>
                            </svg>
                            Descargar
                        </button>
                    </div>
                </div>

                <button (click)="handleComplete()"
                    class="w-full px-4 py-2.5 bg-[#02ab74] hover:bg-[#028a5f] text-white rounded-lg font-medium transition-colors">
                    Finalizar Configuración
                </button>
            </div>
        </div>
    </div>
</div>